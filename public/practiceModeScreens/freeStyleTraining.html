<!DOCTYPE html>
<html>
<head>
    <title>Freestyle Training</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
        }
        #game-container {
            width: 1280px;
            height: 720px;
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            border: 2px solid #333;
            border-radius: 4px;
            overflow: hidden;
        }
        #game-video {
            width: 1280px;
            height: 720px;
            object-fit: contain;
            display: none;
            background: #000;
        }
        #start-button {
            padding: 20px 40px;
            font-size: 24px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        #start-button:hover {
            background: #45a049;
        }
        #start-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        #error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 5px;
            display: none;
            z-index: 1000;
        }
        #debug-log {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            color: white;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <video id="game-video" autoplay></video>
        <button id="start-button">Start Freestyle Training</button>
    </div>
    <div id="error-message"></div>
    <div id="debug-log"></div>
    <script>
        // Initialize elements first
        const videoElement = document.getElementById('game-video');
        const startButton = document.getElementById('start-button');
        const errorDiv = document.getElementById('error-message');
        const debugLog = document.getElementById('debug-log');
        let gameRunning = false;

        // Make debug log visible by default in non-Electron mode
        debugLog.style.display = 'block';

        // Check for Electron APIs - but don't require them
        const electronAPI = window.electronAPI;
        const ipcRenderer = electronAPI?.ipcRenderer;
        
        // Log which mode we're running in
        const isElectron = !!(electronAPI && ipcRenderer);
        log('Initializing in ' + (isElectron ? 'Electron' : 'browser') + ' mode');

        function log(message) {
            const time = new Date().toLocaleTimeString();
            const logMessage = `[${time}] ${message}`;
            console.log(logMessage);
            debugLog.innerHTML += logMessage + '<br>';
            debugLog.scrollTop = debugLog.scrollHeight;
            debugLog.style.display = 'block';
        }

        function showError(message) {
            errorDiv.textContent = `Error: ${message}`;
            errorDiv.style.display = 'block';
            startButton.disabled = false;
            startButton.textContent = 'Start Freestyle Training';
        }

        async function startGame() {
            if (gameRunning) {
                log('Game already running, ignoring start request');
                return;
            }
            
            try {
                startButton.disabled = true;
                startButton.textContent = 'Starting...';
                log('Starting game...');

                if (electronAPI?.ipcRenderer?.send) {
                    log('Using Electron IPC to start game');
                    electronAPI.ipcRenderer.send('start-game');
                } else {
                    log('Using server endpoint to start game');
                    try {
                        log('Sending POST request to launch game...');
                        // Calculate absolute screen coordinates of the game container and send them
                        const rect = document.getElementById('game-container').getBoundingClientRect();
                        const dpr = window.devicePixelRatio || 1;
                        const absoluteX = Math.round((window.screenX + rect.left) * dpr);
                        const absoluteY = Math.round((window.screenY + rect.top) * dpr);
                        const payload = {
                            x: absoluteX,
                            y: absoluteY,
                            width: Math.round(rect.width * dpr),
                            height: Math.round(rect.height * dpr)
                        };
                        log('Computed screen payload: ' + JSON.stringify(payload));

                        const resp = await fetch('/launch-ikemen', { 
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload)
                        });
                        log('Server response status: ' + resp.status);
                        
                        if (!resp.ok) {
                            const errorText = await resp.text();
                            throw new Error(`Server rejected launch request (${resp.status}): ${errorText}`);
                        }
                        
                        const data = await resp.json();
                        log('Server response data: ' + JSON.stringify(data));

                        if (data.error) {
                            throw new Error(data.error);
                        }

                        log('Game launch requested, PID: ' + (data.pid || 'unknown'));

                        // Attempt a follow-up position request (retry) in case initial positioning
                        // didn't perfectly align. Use the same payload we used for launch.
                        try {
                            const posResp = await fetch('/position-window', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(Object.assign({ pid: data.pid }, payload))
                            });
                            const posData = await posResp.json();
                            log('Position response: ' + JSON.stringify(posData));
                        } catch (posErr) {
                            log('Position retry failed: ' + (posErr && posErr.message ? posErr.message : posErr));
                        }

                        log('Waiting 1.5 seconds before showing game status...');
                        setTimeout(() => {
                            log('Starting window capture / status display...');
                            captureGameWindow();
                        }, 1500);
                    } catch (err) {
                        throw new Error('Failed to launch game: ' + (err.message || err));
                    }
                }
            } catch (error) {
                showError('Failed to start game: ' + error.message);
                log('Start game error: ' + error.message);
                startButton.disabled = false;
                startButton.textContent = 'Start Freestyle Training';
            }
        }

        async function captureGameWindow() {
            try {
                log('Game window should appear in container...');
                startButton.style.display = 'none';
                gameRunning = true;

                // In non-Electron mode, the game window is positioned by the server
                // Hide the video element since we're not using capture
                videoElement.style.display = 'none';

                // Add a message to show game status
                const statusDiv = document.createElement('div');
                statusDiv.style.color = 'white';
                statusDiv.style.padding = '20px';
                statusDiv.textContent = 'Game Running...';
                document.getElementById('game-container').appendChild(statusDiv);

            } catch (error) {
                showError('Error: ' + (error && error.message ? error.message : error));
                log('Error: ' + (error && error.message ? error.message : error));
            }
        }

        // Event listeners
        startButton.addEventListener('click', startGame);

        // Set up IPC listeners if we're in Electron mode
        if (electronAPI?.ipcRenderer?.on) {
            electronAPI.ipcRenderer.on('game-started', () => {
                log('Game process started via IPC');
                captureGameWindow();
            });

            electronAPI.ipcRenderer.on('game-error', (message) => {
                showError(message);
                log('Game error via IPC: ' + message);
            });

            electronAPI.ipcRenderer.on('game-exit', () => {
                log('Game exited via IPC');
                videoElement.style.display = 'none';
                startButton.style.display = 'block';
                startButton.disabled = false;
                startButton.textContent = 'Start Freestyle Training';
                gameRunning = false;
            });
        }

        // Log startup
        log('Freestyle Training page loaded');
    </script>
</body>
</html>