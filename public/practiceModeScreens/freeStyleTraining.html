<!DOCTYPE html>
<html>
<head>
    <title>Freestyle Training</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
        }
        #game-container {
            width: 1280px;
            height: 720px;
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            border: 2px solid #333;
            border-radius: 4px;
            overflow: hidden;
        }
        #game-video {
            width: 1280px;
            height: 720px;
            object-fit: contain;
            display: none;
            background: #000;
        }
        #start-button {
            padding: 20px 40px;
            font-size: 24px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        #start-button:hover {
            background: #45a049;
        }
        #start-button:disabled {
            background: #cccccc;
            cursor: not-allowed;
        }
        #error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 5px;
            display: none;
            z-index: 1000;
        }
        #debug-log {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            color: white;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <video id="game-video" autoplay></video>
        <button id="start-button">Start Freestyle Training</button>
    </div>
    <div id="error-message"></div>
    <div id="debug-log"></div>
    <script>
        // Check for Electron APIs - but don't require them
        const electronAPI = window.electronAPI;
        const ipcRenderer = electronAPI?.ipcRenderer;
        
        // Initialize elements
        const videoElement = document.getElementById('game-video');
        const startButton = document.getElementById('start-button');
        
        // Log which mode we're running in
        const isElectron = !!(electronAPI && ipcRenderer);
        log(isElectron ? 'Running in Electron mode' : 'Running in browser mode');
        const errorDiv = document.getElementById('error-message');
        const debugLog = document.getElementById('debug-log');
        let gameRunning = false;

        function log(message) {
            const time = new Date().toLocaleTimeString();
            const logMessage = `[${time}] ${message}`;
            console.log(logMessage);
            debugLog.innerHTML += logMessage + '<br>';
            debugLog.scrollTop = debugLog.scrollHeight;
            debugLog.style.display = 'block';
        }

        function showError(message) {
            errorDiv.textContent = `Error: ${message}`;
            errorDiv.style.display = 'block';
            startButton.disabled = false;
            startButton.textContent = 'Start Freestyle Training';
        }

        async function startGame() {
            if (gameRunning) {
                log('Game already running, ignoring start request');
                return;
            }
            
            try {
                startButton.disabled = true;
                startButton.textContent = 'Starting...';
                log('Starting game...');

                if (electronAPI?.ipcRenderer?.send) {
                    log('Using Electron IPC to start game');
                    electronAPI.ipcRenderer.send('start-game');
                } else {
                    log('Using server endpoint to start game');
                    try {
                        log('Sending POST request to /launch-ikemen...');
                        const resp = await fetch('/launch-ikemen', { 
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });
                        log('Server response status: ' + resp.status);
                        
                        if (!resp.ok) {
                            const errorText = await resp.text();
                            throw new Error(`Server rejected launch request (${resp.status}): ${errorText}`);
                        }
                        
                        const data = await resp.json();
                        log('Server response data: ' + JSON.stringify(data));
                        
                        if (data.error) {
                            throw new Error(data.error);
                        }
                        
                        log('Game launch requested, PID: ' + (data.pid || 'unknown'));
                        log('Waiting 2 seconds before starting capture...');
                        setTimeout(() => {
                            log('Starting window capture...');
                            captureGameWindow();
                        }, 2000);
                    } catch (err) {
                        throw new Error('Failed to launch game: ' + (err.message || err));
                    }
                }
            } catch (error) {
                showError('Failed to start game: ' + error.message);
                log('Start game error: ' + error.message);
                startButton.disabled = false;
                startButton.textContent = 'Start Freestyle Training';
            }
        }

        async function captureGameWindow() {
            try {
                log('Trying to capture Ikemen GO window...');

                // If desktopCapturer is available use it to select the specific window by id
                // Use the preload-exposed API to get sources
                const maxRetries = 12;
                let source = null;
                for (let i = 0; i < maxRetries; i++) {
                        let res = { success: false };
                        if (electronAPI && typeof electronAPI.getSources === 'function') {
                            res = await electronAPI.getSources({ types: ['window', 'screen'], thumbnailSize: { width: 320, height: 180 } });
                        } else {
                            res = { success: false, error: 'electronAPI unavailable' };
                        }

                        if (!res.success) {
                            log('getSources error or unavailable: ' + (res.error || '<none>'));
                            // Fall back to getDisplayMedia if getSources not available
                            break;
                        }

                        const sources = res.sources || [];
                    log('Available sources: ' + (sources.map(s => s.name).join(', ') || '<none>'));

                    source = sources.find(s => {
                        const name = (s.name || '').toLowerCase();
                        return name.includes('ikemen') || name.includes('m.u.g.e.n') || name.includes('ikemen_go');
                    });

                    if (source) break;
                    log(`Ikemen window not found, retry ${i + 1}/${maxRetries}...`);
                    await new Promise(r => setTimeout(r, 1000));
                }

                if (source) {
                    log('Found source: ' + source.name + ' (id=' + source.id + ')');

                    // Use the source.id as chromeMediaSourceId to capture only that window
                    const constraints = {
                        audio: false,
                        video: {
                            mandatory: {
                                chromeMediaSource: 'desktop',
                                chromeMediaSourceId: source.id,
                                minWidth: 1280,
                                maxWidth: 1920,
                                minHeight: 720,
                                maxHeight: 1080
                            }
                        }
                    };

                    let stream;
                    try {
                        stream = await navigator.mediaDevices.getUserMedia(constraints);
                    } catch (err) {
                        // Some Chromium builds require getDisplayMedia for window capture; fall back
                        log('getUserMedia with chromeMediaSourceId failed: ' + (err && err.message ? err.message : err));
                        stream = null;
                    }
                    if (!stream) {
                        // fall back to prompt the user to pick the Ikemen window
                        log('Falling back to getDisplayMedia to let user pick the Ikemen window');
                        stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });
                    }
                    videoElement.srcObject = stream;
                    videoElement.style.display = 'block';
                    await videoElement.play();

                    // Hide the button only after capture is running
                    startButton.style.display = 'none';
                    gameRunning = true;
                    log('Game capture started successfully for: ' + source.name);
                } else {
                    // desktopCapturer/getSources not available or Ikemen not found — fall back to user-pick
                    log('Falling back to getDisplayMedia — please pick the Ikemen GO window in the chooser');
                    try {
                        const dispStream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: false });
                        videoElement.srcObject = dispStream;
                        videoElement.style.display = 'block';
                        await videoElement.play();
                        startButton.style.display = 'none';
                        gameRunning = true;
                        log('Display capture started (user-selected source)');
                    } catch (err) {
                        throw new Error('getDisplayMedia failed or user cancelled: ' + (err && err.message ? err.message : err));
                    }
                }
            } catch (error) {
                showError('Failed to capture game: ' + (error && error.message ? error.message : error));
                log('Capture error: ' + (error && error.message ? error.message : error));
            }
        }

        // Event listeners
        startButton.addEventListener('click', startGame);

        // Set up IPC listeners if we're in Electron mode
        if (electronAPI?.ipcRenderer?.on) {
            electronAPI.ipcRenderer.on('game-started', () => {
                log('Game process started via IPC');
                captureGameWindow();
            });

            electronAPI.ipcRenderer.on('game-error', (message) => {
                showError(message);
                log('Game error via IPC: ' + message);
            });

            electronAPI.ipcRenderer.on('game-exit', () => {
                log('Game exited via IPC');
                videoElement.style.display = 'none';
                startButton.style.display = 'block';
                startButton.disabled = false;
                startButton.textContent = 'Start Freestyle Training';
                gameRunning = false;
            });
        }

        // Log startup
        log('Freestyle Training page loaded');
    </script>
</body>
</html>