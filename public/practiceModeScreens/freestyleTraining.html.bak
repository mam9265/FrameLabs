<!DOCTYPE html>
<html>
<head>
    <title>Freestyle Training</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
        }
        #game-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        #game-video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }
        #error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 5px;
            display: none;
        }
        #debug-log {
            position: fixed;
            bottom: 0;
            left: 0;
            color: white;
            background: rgba(0, 0, 0, 0.8);
            padding: 5px;
            font-family: monospace;
            font-size: 12px;
            display: none;
        }
    </style>
</head>
<body>
    <div id="game-container">
        <video id="game-video" autoplay></video>
        <div id="error-message"></div>
    </div>
    <div id="debug-log"></div>
    <script>
        const { ipcRenderer } = require('electron');
        const { desktopCapturer } = require('electron').remote || require('@electron/remote');
        
        const videoElement = document.getElementById('game-video');
        const errorDiv = document.getElementById('error-message');
        const debugLog = document.getElementById('debug-log');

        function log(message) {
            console.log(message);
            debugLog.textContent += message + '\n';
            debugLog.style.display = 'block';
        }

        async function captureGameWindow() {
            try {
                log('Starting window capture...');
                
                // Function to get all window sources
                const getSources = async () => {
                    try {
                        return await desktopCapturer.getSources({
                            types: ['window'],
                            thumbnailSize: { width: 1920, height: 1080 }
                        });
                    } catch (err) {
                        log('Error getting sources: ' + err.message);
                        return [];
                    }
                };

                const sources = await getSources();
                log('Found windows: ' + sources.map(s => s.name).join(', '));

                // Try to find the game window, including minimized windows
                let retries = 0;
                const maxRetries = 10;
                
                const findWindow = async () => {
                    const currentSources = await getSources();
                    return currentSources.find(source => 
                        source.name.toLowerCase().includes('ikemen') || 
                        source.name.toLowerCase().includes('m.u.g.e.n')
                    );
                };

                let ikemenWindow = await findWindow();
                
                while (!ikemenWindow && retries < maxRetries) {
                    log(`Retry ${retries + 1}/${maxRetries} to find game window...`);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    ikemenWindow = await findWindow();
                    retries++;

                if (ikemenWindow) {
                    log('Found game window: ' + ikemenWindow.name);

                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: false,
                        video: {
                            mandatory: {
                                chromeMediaSource: 'desktop',
                                chromeMediaSourceId: ikemenWindow.id
                            }
                        }
                    });

                    videoElement.srcObject = stream;
                    await videoElement.play();
                    log('Game capture started');
                } else {
                    throw new Error('Game window not found');
                }
            } catch (err) {
                log('Capture error: ' + err.message);
                showError(err.message);
            }
        }

        function showError(message) {
            errorDiv.textContent = `Error: ${message}`;
            errorDiv.style.display = 'block';
        }

        // Listen for the capture command
        ipcRenderer.on('capture-game-window', async () => {
            log('Received capture command');
            await captureGameWindow();
        });

        // Handle any game startup errors
        ipcRenderer.on('game-error', (event, message) => {
            showError(message);
        });

        // Handle game logs
        ipcRenderer.on('game-log', (event, message) => {
            log(message);
        });

        // Start debug mode
        debugLog.style.display = 'block';
        log('Freestyle Training page loaded');
    </script>
</body>
</html>

        ipcRenderer.on('game-started', async () => {
            try {
                const sources = await desktopCapturer.getSources({
                    types: ['window'],
                    thumbnailSize: { width: 1920, height: 1080 }
                });

                // Find the Ikemen GO window
                const ikemenWindow = sources.find(source => 
                    source.name.includes('Ikemen') || 
                    source.name.includes('M.U.G.E.N')
                );

                if (ikemenWindow) {
                    // Create video element
                    const video = document.createElement('video');
                    video.style.width = '100%';
                    video.style.height = '100%';
                    video.style.objectFit = 'contain';
                    document.getElementById('game-container').appendChild(video);

                    // Get the video stream
                    const stream = await navigator.mediaDevices.getUserMedia({
                        audio: false,
                        video: {
                            mandatory: {
                                chromeMediaSource: 'desktop',
                                chromeMediaSourceId: ikemenWindow.id,
                                minWidth: 1280,
                                maxWidth: 1920,
                                minHeight: 720,
                                maxHeight: 1080
                            }
                        }
                    });

                    video.srcObject = stream;
                    video.play();
                }
            } catch (err) {
                console.error('Error capturing game window:', err);
            }
        });
    </script>
</body>
</html>